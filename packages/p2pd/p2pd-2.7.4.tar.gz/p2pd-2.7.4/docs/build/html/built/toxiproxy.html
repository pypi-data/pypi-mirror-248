<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toxiproxy client and server &mdash; P2PD 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Future work" href="../future_work.html" />
    <link rel="prev" title="Lightweight web framework" href="http_framework.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            P2PD
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../problems.html">The problem with P2P networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how.html">How P2PD works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using P2PD from Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rest_api.html">The P2PD REST API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Awesome stuff built with P2PD</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="stun.html">STUN client for address lookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="turn.html">TURN client for proxying</a></li>
<li class="toctree-l2"><a class="reference internal" href="netifaces.html">More portable netifaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_client.html">Hyper-usable HTTP client</a></li>
<li class="toctree-l2"><a class="reference internal" href="http_framework.html">Lightweight web framework</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Toxiproxy client and server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#toxiproxy">Toxiproxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-toxic">Adding a toxic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-latency-ms-jitter">add_latency(ms, jitter)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-bandwidth-limit-kb">add_bandwidth_limit(kb)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-slow-close-ms">add_slow_close(ms)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-timeout-ms">add_timeout(ms)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-reset-peer-ms">add_reset_peer(ms)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-limit-data-n">add_limit_data(n)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-slicer-n-v-ug">add_slicer(n, v, ug)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../future_work.html">Future work</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">P2PD</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Awesome stuff built with P2PD</a></li>
      <li class="breadcrumb-item active">Toxiproxy client and server</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/built/toxiproxy.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="toxiproxy-client-and-server">
<h1>Toxiproxy client and server<a class="headerlink" href="#toxiproxy-client-and-server" title="Permalink to this heading"></a></h1>
<p>When it comes to network programming so much of the process is temperamental.
What I mean by this is the way algorithms perform ultimately ends up
being decided by changing network conditions. If we are to write good
network code there is a need to be able to write algorithms that can
handle many common and unexpected scenarios. But how should one do this?</p>
<p>One cannot simply test their code on the Internet or loopback and hope
for the best. This does not lead to a reliable or systematic approach.
What is needed is a way to model adverse network conditions. So that we
may test how our algorithms deal with unexpected events. One such design
that seems ideally suited for this is Toxiproxy by Shopify.</p>
<section id="toxiproxy">
<h2>Toxiproxy<a class="headerlink" href="#toxiproxy" title="Permalink to this heading"></a></h2>
<p>Toxiproxy consists of a main REST server that spawns sub-servers or tunnels
that are used as relays to different target machines. You can modify behaviors in
these relays - allowing you to test everything from latency to packet recombination algorithms.</p>
<p>Toxiproxy refers to the start of the relay (you) as the <strong>downstream</strong>
while the point that the relay connects to is called the <strong>upstream</strong>.
The algorithms that induce various network behaviors it calls <strong>toxics.</strong>
For example: you can spawn a tunnel server with example.com as the upstream
and set a latency toxic on the upstream (to delay replies back to you.)</p>
<p>The design of Toxiproxy can be used from any programming language because
it’s simply a REST API and then custom TCP daemons. Shopify’s implementation
is written in Go with many clients available in different programming languages.
However, what I’ve found is that the client available for Python was incomplete;
wasn’t async; and there was no server implementation.</p>
<p>It is much easier to include Toxiproxy for testing Python network code if
you don’t also have to figure out how to package a Go server. So P2PD now
includes both a Toxiproxy server and client.</p>
</section>
<section id="adding-a-toxic">
<h2>Adding a toxic<a class="headerlink" href="#adding-a-toxic" title="Permalink to this heading"></a></h2>
<p>Let’s start with an example that shows how to add a toxic.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">p2pd</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">TOXID_HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">TOXID_PORT</span> <span class="o">=</span> <span class="mi">8867</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="c1"># Start the Toxiproxy server.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Interface</span><span class="p">()</span><span class="o">.</span><span class="n">start_local</span><span class="p">()</span>
    <span class="n">toxid</span> <span class="o">=</span> <span class="n">ToxiMainServer</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>
    <span class="n">route</span> <span class="o">=</span> <span class="k">await</span> <span class="n">i</span><span class="o">.</span><span class="n">route</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">TOXID_PORT</span><span class="p">,</span> <span class="n">ips</span><span class="o">=</span><span class="n">TOXID_HOST</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">toxid</span><span class="o">.</span><span class="n">listen_specific</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">route</span><span class="p">,</span> <span class="n">TCP</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Create a Toxiproxy client.</span>
    <span class="c1"># This just connects to the server above.</span>
    <span class="n">toxid_addr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Address</span><span class="p">(</span><span class="n">TOXID_HOST</span><span class="p">,</span> <span class="n">TOXID_PORT</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ToxiClient</span><span class="p">(</span><span class="n">toxid_addr</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># Create a new relay to an upstream.</span>
    <span class="c1"># The upstream location is set bellow.</span>
    <span class="n">relay_dest</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;example.com&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
    <span class="n">tunnel</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">new_tunnel</span><span class="p">(</span><span class="n">relay_dest</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Add an upstream &#39;toxic&#39; that adds latency to replies.</span>
    <span class="n">toxic</span> <span class="o">=</span> <span class="n">ToxiToxic</span><span class="p">()</span><span class="o">.</span><span class="n">upstream</span><span class="p">()</span><span class="o">.</span><span class="n">add_latency</span><span class="p">(</span><span class="n">ms</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">new_toxic</span><span class="p">(</span><span class="n">toxic</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Get a pipe to the tunnel (you&#39;re the &#39;downstream.&#39;)</span>
    <span class="c1"># Send data down the tunnel to the upstream.</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">tunnel_tup</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">get_pipe</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;some malformed http req</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># ... response in 2 sec +/- jitter ms.</span>
    <span class="c1"># If you care to do a recv here...</span>
    <span class="c1">#</span>
    <span class="c1"># Cleanup everything gracefully.</span>
    <span class="k">await</span> <span class="n">pipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">toxid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># Give tasks time to finish..</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">async_test</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>
</div>
<p>So what’s going on here? Well, you’ve started a toxiproxy server and
made a new toxiproxy client that has connected to it. You’ve created
a new tunnel (spawning a new port to connect to) which connects to
example.com as it’s ‘upstream’ location.</p>
<p>You can control what ‘toxics’ are active on this tunnel server. Allowing
you to set direction (is it upstream or downstream), probability of activation
(also known as ‘toxicity’), and much more. If you send a HTTP request down
‘pipe’ you will now get a delayed response due to the latency toxic.</p>
<p>I have added support for the toxics specified by Shopify. The rest
of these toxics assume calling ToxiToxic().upstream().toxic_name…
or ToxiToxic().downstream().toxic_name.</p>
</section>
<section id="add-latency-ms-jitter">
<h2>add_latency(ms, jitter)<a class="headerlink" href="#add-latency-ms-jitter" title="Permalink to this heading"></a></h2>
<p>Adds N ms of latency with +/- jitter (random inclusive.)</p>
</section>
<section id="add-bandwidth-limit-kb">
<h2>add_bandwidth_limit(kb)<a class="headerlink" href="#add-bandwidth-limit-kb" title="Permalink to this heading"></a></h2>
<p>Adds a limit of kb kilobytes per second.</p>
</section>
<section id="add-slow-close-ms">
<h2>add_slow_close(ms)<a class="headerlink" href="#add-slow-close-ms" title="Permalink to this heading"></a></h2>
<p>Adds a delay to the connection being closed. So even if close is called on a pipe due in the code that coroutine will be delayed.</p>
</section>
<section id="add-timeout-ms">
<h2>add_timeout(ms)<a class="headerlink" href="#add-timeout-ms" title="Permalink to this heading"></a></h2>
<p>Prevents data from being forwarded and closes the connection after timeout.
If timeout is set to 0 then the connection won’t close and no data will
be delayed on this toxic is removed.</p>
</section>
<section id="add-reset-peer-ms">
<h2>add_reset_peer(ms)<a class="headerlink" href="#add-reset-peer-ms" title="Permalink to this heading"></a></h2>
<p>Normally when you call close() on a socket it ‘gracefully’ closes the connection. So that unsent data is sent and it indicates the sender is finished. This toxic instead tears down a connection immediately (ms=0) or after
a timeout. Unset data will be discarded.</p>
</section>
<section id="add-limit-data-n">
<h2>add_limit_data(n)<a class="headerlink" href="#add-limit-data-n" title="Permalink to this heading"></a></h2>
<p>Keeps a count of the number of bytes sent. When it reaches n the
connection is closed.</p>
</section>
<section id="add-slicer-n-v-ug">
<h2>add_slicer(n, v, ug)<a class="headerlink" href="#add-slicer-n-v-ug" title="Permalink to this heading"></a></h2>
<p>When you call recv with BSD sockets and TCP you may receive some
or all of your data. Some people assume that recv corresponds to
each send but in reality TCP is a stream-oriented protocol. The
slicer takes received data and splits them up into multiple sends.
Where n is the average byte no of a packet, v is the variation in
bytes of an average packet, and ug is the microseconds to sends by.</p>
<p>There are tests that show usage for all of the above toxics.
See tests/test_toxid.py for an example.</p>
<p>See <a class="reference external" href="https://github.com/Shopify/toxiproxy">https://github.com/Shopify/toxiproxy</a> for more information.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="http_framework.html" class="btn btn-neutral float-left" title="Lightweight web framework" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../future_work.html" class="btn btn-neutral float-right" title="Future work" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>