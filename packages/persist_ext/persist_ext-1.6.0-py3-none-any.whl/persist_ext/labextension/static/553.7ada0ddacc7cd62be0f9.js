"use strict";(self.webpackChunkpersist_ext=self.webpackChunkpersist_ext||[]).push([[553],{553:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ee});var r=n(714),a=n(807),o=n(122),s=n(190),i=n(405),l=n(154),c=n(590),d=n(118);function u(e){return(0,d.decompressFromUTF16)(e)}function h(e){return{getItem(t){window.Persist.Notebook.udpatePersistKeyRecord(t);const n=e.model.getMetadata(t);return n?u(n):n},setItem(t,n){e.model.setMetadata(t,n?(0,d.compressToUTF16)(n):n)},removeItem:t=>e.model.deleteMetadata(t)}}var m=n(128),p=n(901),g=n(103);function _(){return(0,g.v4)()}const y={id:_(),type:"create"};class b{static getInstance(e){return new b(e)}constructor(e){this._cell=e,this._notifyTrrackInstanceChange=new p.Signal(this),this._registry=m.Registry.create(),this._notifyCurrentChange=new p.Signal(this),this._unsubscribeCurrentChangeListener=null,this.undoRedoStatus=(0,i.hookstate)({canUndo:!1,canRedo:!1}),b._instanceMaps.set(e,this),this._addInteractionAction=this._registerAddInteractionAction(),this.loadTrrack(this._cell.trrackGraph)}get trrackInstanceChange(){return this._notifyTrrackInstanceChange}get currentChange(){return this._notifyCurrentChange}get trrack(){return this._trrack}reset(){this.loadTrrack(),this._cell.generatedDataframesState.set({})}saveToJupyter(){this._cell.trrackGraphState.set(this._graph)}loadTrrack(e=null){const t=()=>{this._cell.trrackGraphState.set(this._graph),this.undoRedoStatus.nested("canUndo").set(this.trrack.current.id!==this.trrack.root.id),this.undoRedoStatus.nested("canRedo").set(this.trrack.current.children.length>0),window.Persist.Commands.registry.notifyCommandChanged(),this._notifyCurrentChange.emit(this._trrack.current.id)};this._unsubscribeCurrentChangeListener&&this._unsubscribeCurrentChangeListener(),this._trrack=(0,m.initializeTrrack)({registry:this._registry,initialState:y}),e&&e.root!==this._trrack.root.id&&this._trrack.importObject(e),this._unsubscribeCurrentChangeListener=this._trrack.currentChange(t),t(),this._notifyTrrackInstanceChange.emit(this._trrack)}apply(e,t){return this._trrack.apply(function(e){return"function"==typeof e?e():e}(t),this._addInteractionAction(e))}get _graph(){return this._trrack.exportObject()}_registerAddInteractionAction(){return e=>(this._registry.has(e.type)||this._registry.register(e.type,((e,t)=>t)),{type:e.type,payload:e})}}b._instanceMaps=new WeakMap;var f=n(439);const C="trrack_graph",k="__GENERATED_DATAFRAMES__";class v extends r.CodeCell{constructor(e){if(super(e),this.__trrackGraph=null,this._trrackManager=null,!window.Persist.CellMap)throw new Error("Entry point not executed");window.Persist.CellMap.set(this.cell_id,this);const t=this.model.getMetadata(k);t&&JSON.parse(u(t)),this._generatedDataframes=(0,i.hookstate)({},(0,i.extend)((0,c.subscribable)(),(0,l.localstored)({key:k,engine:h(this)}))),this.node.dataset.id=this.cell_id,this.node.dataset.celltype="code-cell";const n=async(e,t)=>{await this.ready;const n=this.node.querySelector(".jp-CellFooter");0===e.length?this.model.getMetadata(C)&&n&&(n.style.height="auto",n.innerHTML='\n                <div style="height:20px;width:100%;text-align:center">\n                This cell is a persist cell. Please run the cell to enable interactive output.\n                </div>\n                  '):n&&(n.innerHTML="")};this.model.outputs.changed.connect(n,this),n(this.model.outputs)}get _trrackGraph(){if(null===this.__trrackGraph){const e=this.model.getMetadata(C),t=e?JSON.parse(u(e)):null;this.__trrackGraph=(0,i.hookstate)(t,(0,l.localstored)({key:C,engine:h(this)}))}return this.__trrackGraph}get trrackManager(){return this._trrackManager||(this._trrackManager=b.getInstance(this)),this._trrackManager}tagAsPersistCell(e=!0){this.model.setMetadata("__has_persist_output",e)}get generatedDataframesState(){return this._generatedDataframes}get generatedDataframes(){return e=this._generatedDataframes.get({noproxy:!0}),JSON.parse(JSON.stringify(e));var e}get trrackGraphState(){return this._trrackGraph}get trrackGraph(){return e=this._trrackGraph.get({noproxy:!0}),(0,f.cloneDeep)(e);var e}get cell_id(){return this.model.id}dispose(){this.isDisposed||(window.Persist.CellMap.delete(this.cell_id),p.Signal.clearData(this),super.dispose())}}!function(e){e.create=function(t){return new e(t)},e.isTrrackableCell=function(t){return t instanceof e}}(v||(v={}));class w extends o.NotebookPanel.ContentFactory{createCodeCell(e){return v.create(e).initializeState()}}var S=n(930);const M="__persist_nb_uuid__",x="__persist_keys_record",P=Symbol("__delete_nb_metadata");class D{constructor(e=null){var t;this._nbPanel=e,this._setupFinishDelegate=new S.PromiseDelegate,this._nb=null==e?void 0:e.content,null===(t=this._nbPanel)||void 0===t||t.context.ready.then((()=>async function(e){return await async function(e){return e.model&&(e.nbUid||(e.model.setMetadata(M,_()),await e.save())),Promise.resolve()}(e),Promise.resolve()}(this))).then((()=>{this.udpatePersistKeyRecord(M),this._setupFinishDelegate.resolve()}))}get nb(){return this._nb}get nbPanel(){return this._nbPanel}get model(){var e;return null===(e=this._nbPanel)||void 0===e?void 0:e.model}get setupFinish(){return this._setupFinishDelegate.promise}get nbUid(){var e;return null===(e=this.model)||void 0===e?void 0:e.getMetadata(M)}forEachCell(e){var t;const n=null===(t=this.model)||void 0===t?void 0:t.cells;if(n)for(let t=0;t<n.length;++t)e(n.get(t))}udpatePersistKeyRecord(e,t=!1){const n=this.metadata.get(x)||[];t&&n.splice(0,n.length);const r=("string"==typeof e?[e]:e).filter((e=>!n.includes(e)));n.push(...r),n.length>0&&this.metadata.write(x,[...new Set(n)])}getPersistKeyRecord(){return this.metadata.get(x)||[]}get metadata(){const e=this.model;return{get:function(t){return null==e?void 0:e.getMetadata(t)},write:function(t,n){n===P?null==e||e.deleteMetadata(t):null==e||e.setMetadata(t,n)}}}save(e=!1){var t,n;return e?null===(t=this._nbPanel)||void 0===t?void 0:t.context.saveAs():null===(n=this._nbPanel)||void 0===n?void 0:n.context.save()}}function $(e){return e?(n=e,t=JSON.stringify(n),JSON.parse(t)):e;var t,n}var N=n(61);const R={execute(e){const{cell:t,name:n,value:r,store:a,brush_type:o}=e,{action:s,label:i}=(l={value:r,name:n,store:$(a),brush_type:o},{action:{id:_(),type:"select",...l},label:()=>{const{brush_type:e,name:t,value:n,store:r}=l;if("non-vega"===e){const e=n;return 1===e.length?`Selected ${e.length} point`:0===e.length?"Clear selections":`Selected ${e.length} points`}if(0===r.length)return"Clear selections";if("non-vega-null"===e)return`Selected missing or invalid for '${t}'`;if(0===r.length)return"Clear selections";if("interval"===e){const e=n,t=[];return Object.entries(e).forEach((([e,n])=>{const r=`${e} (${n[0]instanceof Date?n[0].toUTCString():(0,N.isNumeric)(n[0])?Math.round(n[0]):n[0]} to ${n[n.length-1]instanceof Date?n[n.length-1].toUTCString():(0,N.isNumeric)(n[n.length-1])?Math.round(n[n.length-1]):n[n.length-1]})`;t.push(r)})),"Selected "+t.join(", ")}{const e=n;if(e.vlPoint&&e.vlPoint.or){const t=e.vlPoint.or;if(t.length>0)return`Selected ${t.length} ${1===t.length?"point":"points"} across ${Object.keys(t[0]).join(", ")}`}else if("index_selection"===t){const e=n;return 1===e.length?`Selected ${e.length} point`:`Selected ${e.length} points`}}return"Selected Points!"}});var l;return t.trrackManager.apply(s,i)}};function T(e){const{cell:t}=e;return"select"===t.trrackManager.trrack.getState().type}const E={isEnabled:e=>T(e),execute(e){const{cell:t,direction:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"filter",direction:e},label:()=>"out"===e?"Removed selected items":"Kept selected items"}}(n);return t.trrackManager.apply(r,a)},label:e=>{const{direction:t}=e;return"out"===t?"Remove selection":"Keep only selection"}},I={isEnabled:e=>T(e),execute(e){const{cell:t,text:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"annotate",text:e,createdOn:Date.now()},label:()=>"Add annotation to selection: "+e}}(n);return t.trrackManager.apply(r,a)}};var A=n(120);const O={execute(e){const{cell:t,renameColumnMap:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"rename_column",renameColumnMap:e},label:()=>{const t=Object.entries(e);return 0===t.length?"Rename Action":1===t.length?`Rename column ${t[0][0]} to ${t[0][1]}`:`Rename ${t.length} columns`}}}(n);return t.trrackManager.apply(r,a)},label:"Rename Column"},F={execute(e){const{cell:t,columns:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"drop_columns",columns:e},label:()=>e.length>1?`Drop ${e.length} columns`:`Drop column ${e[0]}`}}(n);return t.trrackManager.apply(r,a)},label:"Drop Columns"},G={execute(e){const{cell:t,action:n,overrideLabel:r}=e,{action:a,label:o}=function(e){return{action:{id:_(),type:"category",action:e},label:()=>{let t="";switch(e.op){case"add":t+="Add ";break;case"remove":t+="Remove ";break;case"assign":t+="Assign ";break;case"reorder":t+=`Reorder options for '${e.category}'`}switch(e.scope){case"category":t+=`new category '${e.category}'`;break;case"option":"assign"===e.op?t+=`'${e.category} (${e.option})' to selected items.`:t+=`'${e.option}' ${"add"===e.op?"to":"from"} ${e.category}`}return t}}}(n);return t.trrackManager.apply(a,r||o)},label:"Assign Category"},j={execute(e){const{cell:t,sortStatus:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"sortby_column",sortStatus:e},label:()=>{if(0===e.length)return"Reset sorting";const t=e.map((e=>`Sort (${e.desc?"descending":"ascending"}) by '${e.id}'`));return 1===t.length?t[0]:`Sort by ${t.length} columns. ${t.join("|\n")}`}}}(n);return t.trrackManager.apply(r,a)},label:"Sort Column"},L={execute(e){const{cell:t,columns:n,overrideLabel:r}=e;if(0===n.length)return;const{action:a,label:o}=function(e){return{action:{id:_(),type:"reorder_column",columns:e},label:()=>"Reorder columns"}}(n);return t.trrackManager.apply(a,r||o)},label:"Reorder Columns"},J={execute(e){const{cell:t,columnDataTypes:n}=e,{action:r,label:a}=function(e){return{action:{id:_(),type:"column_type_change",columnDataTypes:e},label:()=>{const t=Object.entries(e);return 1===t.length?`Changed column '${t[0][0]}' type to '${t[0][1].type}'`:t.length>1?`Changed types for ${t.length} columns`:"Change columns"}}}(n);return t.trrackManager.apply(r,a)},label:"Reorder Columns"},U={execute(e){const{cell:t,columnName:n,idx:r,value:a}=e,{action:o,label:s}=function(e,t,n){return{action:{id:_(),type:"edit_cell",columnName:e,idx:t,value:n},label:()=>`Updated column '${e}', idx ${t} to '${n}'`}}(n,r,a);return t.trrackManager.apply(o,s)},label:"Reorder Columns"},K={execute(e){const{intent:t,cell:n,name:r,value:a,store:o,brush_type:s}=e,{action:i,label:l}=function(e,t){return{action:{id:_(),type:"intent",intent:e,...t},label:()=>`Selected ${e.intent}`}}(t,{value:a,name:r,store:$(o),brush_type:s});return n.trrackManager.apply(i,l)}},z={execute(e){const{record:t,model:n,post:r}=e;n.set("gdr_signal",{record:t,post:r}),n.save_changes()}},W={execute(e){const{cell:t}=e},label:"Delete generated dataframe"},q={execute(e){const{record:t}=e;(async function(e){return await navigator.clipboard.writeText(e)})(t.dfName).then((()=>{var e;e=t.dfName,window.Persist.Notification.notify(`Copied code for df: ${e}`,"success",{autoClose:500})})).catch((e=>{var n,r;console.error(e),n=t.dfName,r=e,window.Persist.Notification.notify(`Failed to copy ${n} to clipboard. ${r}`,"error",{autoClose:500})}))}},B={execute(e){const{record:t}=e;!function(e){var t,n;const r=null===(t=window.Persist.Notebook.nbPanel)||void 0===t?void 0:t.content;if(!r)return;o.NotebookActions.insertBelow(r);const a=r.activeCell;if(a){if(a.model.sharedModel.getSource().length>0)throw new Error("New codecell should have no content!");a.model.sharedModel.setSource(e),o.NotebookActions.run(r,null===(n=window.Persist.Notebook.nbPanel)||void 0===n?void 0:n.sessionContext),a.node.scrollIntoView(!0)}}(`${t.dfName}.head()`)}};var H,V;(V=H||(H={})).resetTrrack="persist:trrack:reset",V.pointSelection="persist:selection:point",V.intervalSelection="persist:selection:interval",V.intentSelection="persist:selection:intent",V.invertSelection="persist:selection:invert",V.clearSelection="persist:selection:clear",V.categorize="persist:category:assign",V.filterOut="persist:filter:out",V.filterIn="persist:filter:in",V.sortByColumn="persist:column:sort",V.reorderColumns="persist:column:order",V.renameColumns="persist:column:rename",V.dropColumns="persist:column:drop",V.changeColumnDataType="persist:column:changetype",V.annotate="persist:annotate",V.editCell="persist:data:edit",V.createDataframe="persist:dataframe:create",V.copyDataframe="persist:dataframe:copy",V.insertCellWithDataframe="persist:dataframe:insert-cell",V.deleteDataframe="persist:dataframe:delete";class Q{constructor(){this._commandsDisposeMap=new Map,this._commands=new A.CommandRegistry,this.addCommand(H.resetTrrack,{isEnabled(e){const{cell:t}=e,{nodes:n}=t.trrackManager.trrack.exportObject();return Object.keys(n).length>1},execute(e){const{cell:t}=e;t.trrackManager.reset()},label:"Reset Trrack"}),this.addCommand(H.pointSelection,R),this.addCommand(H.intervalSelection,R),this.addCommand(H.intentSelection,K),this.addCommand(H.invertSelection,{execute(){throw new Error("not impl")}}),this.addCommand(H.clearSelection,{execute(){throw new Error("not impl")}}),this.addCommand(H.categorize,G),this.addCommand(H.filterOut,E),this.addCommand(H.filterIn,E),this.addCommand(H.sortByColumn,j),this.addCommand(H.reorderColumns,L),this.addCommand(H.renameColumns,O),this.addCommand(H.dropColumns,F),this.addCommand(H.annotate,I),this.addCommand(H.changeColumnDataType,J),this.addCommand(H.editCell,U),this.addCommand(H.createDataframe,z),this.addCommand(H.deleteDataframe,W),this.addCommand(H.copyDataframe,q),this.addCommand(H.insertCellWithDataframe,B)}addCommand(e,t){const n=this._commands.addCommand(e,t);this._commandsDisposeMap.set(e,n)}removeCommand(e){if(!this._commands.hasCommand(e))return!1;const t=this._commandsDisposeMap.get(e);return!!t&&(t.dispose(),this._commandsDisposeMap.delete(e),!0)}execute(e,t){return this._commands.execute(e,t)}get registry(){return this._commands}}var X=n(308);const Y={id:"persist_ext:plugin",description:"PersIst is a JupyterLab extension to enable persistent interactive visualizations in JupyterLab notebooks.",autoStart:!0,requires:[o.INotebookTracker],optional:[s.ISettingRegistry],activate:(e,t,n)=>{console.log("Setting up persist"),window.Persist={CellMap:new Map,Commands:new Q,Notebook:new D,Views:new WeakMap,Notification:{notify:(...e)=>X.Notification.emit(...e)}},t.currentChanged.connect(((e,t)=>{const n=new D(t);window.Persist.Notebook=n,n.setupFinish.then((()=>{console.log(n.nbUid,"is ready!")}))})),console.log("JupyterLab extension persist_ext is activated!"),n&&n.load(Y.id).then((e=>{console.log("persist_ext settings loaded:",e)})).catch((e=>{console.error("Failed to load settings for persist_ext.",e)}))}},Z={id:"persist_ext:trrackable-cell-plugin",description:"Trrackable cell plugin companion",autoStart:!0,provides:o.NotebookPanel.IContentFactory,requires:[a.IEditorServices,X.ICommandPalette],activate:(e,t,n)=>{console.log("JupyterLab extension trrackable-persist-cell is activated!");const{commands:a}=e,o="persist:meta:clear",s="persist:meta:reset-all-trrack";a.addCommand(s,{label:"Reset Trrack instances for all cells",execute:()=>{window.Persist.CellMap.forEach((e=>{(null==e?void 0:e._trrackManager)&&(null==e||e.trrackManager.reset())})),window.Persist.Notebook.save()}}),a.addCommand(o,{label:"Clear all persist metadata from cells and the notebook",execute:()=>{const e=window.Persist.Notebook.getPersistKeyRecord();e.push("__CATEGORIES__","__USER_ADDED_CATEGORIES__"),e.forEach((e=>{window.Persist.Notebook.metadata.write(e,P)})),a.execute(s),window.Persist.CellMap.forEach((t=>{e.forEach((e=>{var n;return null===(n=null==t?void 0:t.model)||void 0===n?void 0:n.deleteMetadata(e)}))})),window.Persist.Notebook.save(),console.log("Cleared persist keys and saved!")}}),n.addItem({category:"Persist",command:o});const i=new r.Cell.ContentFactory({editorFactory:t.factoryService.newInlineEditor});return new w(i)}},ee=[Y,Z]}}]);